<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title><%= profileUser.fullname %>'s Profile | Blogify</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    body { background: #1a2634; color: #ecf0f1; font-family: Arial,sans-serif; margin:0; }
    .container { max-width: 950px; margin: 2rem auto; padding: 2rem; background: #2c3e50; border-radius: 10px; }
    .profile-header { display:flex; gap:2rem; align-items:center; border-bottom:1px solid #34495e; padding-bottom:1.5rem; margin-bottom:2rem;}
    .profile-img { width:90px; height:90px; border-radius:50%; object-fit:cover; border:3px solid #f1c40f;}
    .profile-info { flex:1; }
    .profile-info h2 { margin:0 0 .3rem 0; color:#f1c40f; }
    .profile-info .bio { color:#bfc9d1; margin:0 0 .5rem 0; }
    .profile-actions { display:flex; gap:1rem; }
    .btn { background:#f1c40f; color:#1a2634; border:none; border-radius:5px; padding:0.5rem 1.2rem; font-weight:bold; cursor:pointer;}
    .btn:hover { background: #e1b70e;}
    .follow-counts { display:flex; gap:1.5rem; margin:.8rem 0;}
    .follow-counts div { cursor:pointer; font-weight:bold; }
    .follow-counts span { color:#f1c40f; }
    .blog-list { display: flex; flex-wrap: wrap; gap:2rem;}
    .blog-card { background:#233146; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.16); margin-bottom:2rem; width:340px; position:relative; display:flex; flex-direction:column; }
    .blog-card .cover { width:100%; height:160px; object-fit:cover; border-top-left-radius:10px; border-top-right-radius:10px;}
    .blog-content { padding:1.1rem 1.2rem 0.7rem 1.2rem; flex:1;}
    .blog-title { font-size:1.24rem; font-weight:700; color:#f1c40f; margin:0 0 .4rem 0;}
    .blog-desc { font-size:1rem; color:#ecf0f1; margin-bottom:.9rem;}
    .blog-actions { display:flex; align-items:center; gap:1.2rem; margin-bottom:.5rem;}
    .like-btn { background:none; border:none; color:#f1c40f; font-size:1.1rem; cursor:pointer; }
    .like-btn.liked { color:#e74c3c; }
    .dropdown { position:absolute; right:12px; top:15px; }
    .dropdown-toggle { background:none; border:none; color:#ecf0f1; font-size:1.5rem; cursor:pointer;}
    .dropdown-content { display:none; position:absolute; right:0; top:26px; background:#34495e; min-width:120px; border-radius:6px; box-shadow:0 2px 8px rgba(0,0,0,0.18); z-index:10;}
    .dropdown-content a, .dropdown-content button { color:#ecf0f1; padding:10px 18px; text-decoration:none; display:block; background: none; border:none; text-align:left; width:100%; cursor:pointer;}
    .dropdown-content a:hover, .dropdown-content button:hover { background:#22314a;}
    .dropdown.open .dropdown-content { display:block; }
    .comments { margin-top:1rem; }
    .comment { background:#293548; border-radius:7px; margin-bottom:.8rem; padding:0.8rem 1rem .7rem 1rem; }
    .comment-header { display:flex; align-items:center; gap:.7rem; margin-bottom:.2rem;}
    .comment-img { width:30px; height:30px; border-radius:50%; object-fit:cover; }
    .comment-name { font-weight:600; color:#f1c40f;}
    .comment-date { font-size:.8rem; color:#bfc9d1; margin-left:auto;}
    .comment-body { color:#fff; margin:.3rem 0 .45rem 0;}
    .comment-actions { display:flex; align-items:center; gap:1.2rem; font-size:.97rem;}
    .reply-link { color:#f1c40f; cursor:pointer; }
    .reply-form { margin:.7rem 0 .6rem 2.5rem;}
    .replies-dropdown { margin-left:2.2rem; }
    .replies-toggle { color:#f1c40f; background:none; border:none; font-size:.93rem; cursor:pointer;}
    .reply-card { background:#2d3a50; margin-bottom:.5rem; border-radius:5px; padding:.5rem 1rem;}
    /* Popups for followers/following */
    .popup-bg { display:none; position:fixed; left:0; top:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:99;}
    .popup { background:#263241; margin:7vh auto; max-width:370px; border-radius:10px; padding:2rem 1.5rem; position:relative;}
    .popup-close { position:absolute; right:15px; top:12px; color:#f1c40f; font-size:1.8rem; cursor:pointer;}
    .popup h3 { color:#f1c40f; margin-top:0;}
    .popup-list { max-height:280px; overflow-y:auto;}
    .popup-list .user-row { display:flex; align-items:center; gap:.8rem; margin-bottom:.8rem;}
    .popup-list img { width:34px; height:34px; border-radius:50%; object-fit:cover;}
    .popup-list .name { color:#fff; font-weight:500;}
    @media (max-width: 1050px) { .container { max-width:99vw; } .blog-list {flex-direction:column; align-items:center;} .blog-card {width:98vw;} }
    @media (max-width: 600px) { .container {padding:.5rem;} }
  </style>
</head>
<body>
<%- include('partials/header', { user }) %>
<div class="container">
  <div class="profile-header">
    <img src="<%= profileUser.profileImageURL || '/images/default-avatar.png' %>" alt="Profile" class="profile-img">
    <div class="profile-info">
      <h2><%= profileUser.fullname %> <% if (profileUser.isPrivate) { %><i class="fas fa-lock" title="Private"></i><% } %></h2>
      <div class="bio"><%= profileUser.bio || '' %></div>
      <div class="follow-counts">
        <div id="followersBtn"><span><%= profileUser.followers.length %></span> Followers</div>
        <div id="followingBtn"><span><%= profileUser.following.length %></span> Following</div>
      </div>
      <div class="profile-actions">
        <% if (typeof isOwn !== 'undefined' && !isOwn) { %>
          <% if (isFollowing) { %>
            <button class="btn" disabled>Following</button>
          <% } else { %>
            <form action="/profile/follow/<%= profileUser._id %>" method="POST" style="display:inline;">
              <button class="btn"><i class="fas fa-user-plus"></i> Follow</button>
            </form>
          <% } %>
        <% } %>
      </div>
    </div>
  </div>

  <% if ((typeof isOwn !== 'undefined' && isOwn) || isFollowing) { %>
    <div class="blog-list">
      <% blogs.forEach(blog => { %>
        <div class="blog-card" id="blog-<%= blog._id %>">
          <% if (blog.coverImage) { %>
            <img src="<%= blog.coverImage %>" class="cover" alt="cover">
          <% } %>
          <div class="dropdown" data-blogid="<%= blog._id %>">
            <button class="dropdown-toggle"><i class="fas fa-ellipsis-v"></i></button>
            <div class="dropdown-content">
              <a href="javascript:void(0)" onclick="shareBlog('<%= blog._id %>')"><i class="fas fa-share"></i> Share Blog</a>
              <% if (typeof isOwn !== 'undefined' && isOwn) { %>
                <form action="/blog/delete/<%= blog._id %>?_method=DELETE" method="POST" style="margin:0;">
                  <button type="submit" onclick="return confirm('Delete this blog?');"><i class="fas fa-trash"></i> Delete Blog</button>
                </form>
              <% } %>
            </div>
          </div>
          <div class="blog-content">
            <div class="blog-title"><%= blog.title %></div>
            <div class="blog-desc"><%= blog.description %></div>
            <div class="blog-actions">
              <form action="/blog/like/<%= blog._id %>" method="POST" style="display:inline;">
                <button type="submit" class="like-btn <%= blog.likedByCurrentUser ? 'liked' : '' %>">
                  <i class="fa<%= blog.likedByCurrentUser ? 's' : 'r' %> fa-heart"></i> <span><%= blog.likes.length %></span>
                </button>
              </form>
              <span><i class="fa-regular fa-comment"></i> <%= blog.comments.length %></span>
            </div>
            <div class="comments">
              <form action="/blog/comment/<%= blog._id %>" method="POST" style="margin-bottom:1rem;">
                <input type="text" name="body" placeholder="Write a comment..." required style="width:80%;padding:.5rem;border-radius:5px;border:none;background:#34495e;color:#fff;">
                <button class="btn" style="padding:.5rem 1rem;"><i class="fas fa-paper-plane"></i> Comment</button>
              </form>
              <% blog.comments.forEach(function(comment) { %>
                <div class="comment" id="comment-<%= comment._id %>">
                  <div class="comment-header">
                    <img src="<%= comment.createdBy.profileImageURL || '/images/default-avatar.png' %>" class="comment-img" alt="u">
                    <span class="comment-name"><%= comment.createdBy.fullname %></span>
                    <span class="comment-date"><%= moment(comment.createdAt).fromNow() %></span>
                  </div>
                  <div class="comment-body"><%= comment.body %></div>
                  <div class="comment-actions">
                    <form action="/comment/like/<%= comment._id %>" method="POST" style="display:inline;">
                      <button type="submit" class="like-btn <%= comment.likedByCurrentUser ? 'liked' : '' %>" style="font-size:1rem;">
                        <i class="fa<%= comment.likedByCurrentUser ? 's' : 'r' %> fa-heart"></i> <span><%= comment.likes.length %></span>
                      </button>
                    </form>
                    <span class="reply-link" onclick="toggleReplyForm('<%= comment._id %>')"><i class="fas fa-reply"></i> Reply</span>
                    <% if (comment.replies && comment.replies.length > 0) { %>
                      <button class="replies-toggle" onclick="toggleReplies('<%= comment._id %>')">
                        <i class="fa fa-chevron-down"></i> View <%= comment.replies.length %> Replies
                      </button>
                    <% } %>
                  </div>
                  <!-- Reply Form -->
                  <form action="/comment/reply/<%= comment._id %>" method="POST" class="reply-form" id="reply-form-<%= comment._id %>" style="display:none;">
                    <input type="text" name="body" placeholder="Write a reply..." required style="width:75%;padding:.4rem;border-radius:4px;border:none;background:#34495e;color:#fff;">
                    <button class="btn" style="padding:.3rem 1rem;"><i class="fas fa-paper-plane"></i></button>
                  </form>
                  <!-- Replies -->
                  <% if (comment.replies && comment.replies.length > 0) { %>
                    <div class="replies-dropdown" id="replies-<%= comment._id %>" style="display:none;">
                      <% comment.replies.forEach(function(reply) { %>
                        <div class="reply-card">
                          <div class="comment-header">
                            <img src="<%= reply.createdBy.profileImageURL || '/images/default-avatar.png' %>" class="comment-img" alt="u">
                            <span class="comment-name"><%= reply.createdBy.fullname %></span>
                            <span class="comment-date"><%= moment(reply.createdAt).fromNow() %></span>
                          </div>
                          <div class="comment-body"><%= reply.body %></div>
                          <div class="comment-actions">
                            <form action="/comment/like/<%= reply._id %>" method="POST" style="display:inline;">
                              <button type="submit" class="like-btn <%= reply.likedByCurrentUser ? 'liked' : '' %>" style="font-size:1rem;">
                                <i class="fa<%= reply.likedByCurrentUser ? 's' : 'r' %> fa-heart"></i> <span><%= reply.likes.length %></span>
                              </button>
                            </form>
                          </div>
                        </div>
                      <% }) %>
                    </div>
                  <% } %>
                </div>
              <% }) %>
            </div>
          </div>
        </div>
      <% }) %>
    </div>
  <% } else { %>
    <div style="text-align:center; margin-top:2rem;">
      <i class="fas fa-lock fa-3x" style="color:#f1c40f;"></i>
      <h2>This account is private. Only followers can see posts.</h2>
    </div>
  <% } %>
</div>

<!-- Followers Popup -->
<div class="popup-bg" id="followersPopup">
  <div class="popup">
    <span class="popup-close" onclick="closePopup('followersPopup')">&times;</span>
    <h3>Followers</h3>
    <div class="popup-list">
      <% profileUser.followers.forEach(f => { %>
        <div class="user-row">
          <img src="<%= f.profileImageURL || '/images/default-avatar.png' %>">
          <span class="name"><%= f.fullname %></span>
        </div>
      <% }) %>
    </div>
  </div>
</div>
<!-- Following Popup -->
<div class="popup-bg" id="followingPopup">
  <div class="popup">
    <span class="popup-close" onclick="closePopup('followingPopup')">&times;</span>
    <h3>Following</h3>
    <div class="popup-list">
      <% profileUser.following.forEach(f => { %>
        <div class="user-row">
          <img src="<%= f.profileImageURL || '/images/default-avatar.png' %>">
          <span class="name"><%= f.fullname %></span>
        </div>
      <% }) %>
    </div>
  </div>
</div>

<script>
  // Blog Card Dropdown
  document.querySelectorAll('.dropdown-toggle').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('open'));
      this.closest('.dropdown').classList.toggle('open');
    });
  });
  document.body.addEventListener('click', function() {
    document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('open'));
  });

  // Share Blog
  function shareBlog(blogId) {
    const url = window.location.origin + '/blog/' + blogId;
    if (navigator.share) {
      navigator.share({ url });
    } else {
      navigator.clipboard.writeText(url);
      alert('Blog link copied!');
    }
  }

  // Reply Form Toggle
  function toggleReplyForm(cid) {
    const el = document.getElementById('reply-form-' + cid);
    if (el) el.style.display = (el.style.display === 'none' || !el.style.display) ? 'block' : 'none';
  }
  // Replies Dropdown
  function toggleReplies(cid) {
    const el = document.getElementById('replies-' + cid);
    if (el) el.style.display = (el.style.display === 'none' || !el.style.display) ? 'block' : 'none';
  }
  // Followers/Following Popups
  document.getElementById('followersBtn').onclick = () => document.getElementById('followersPopup').style.display = 'block';
  document.getElementById('followingBtn').onclick = () => document.getElementById('followingPopup').style.display = 'block';
  function closePopup(id) { document.getElementById(id).style.display = 'none'; }
  window.onclick = function(event) {
    if (event.target.classList && event.target.classList.contains('popup-bg')) event.target.style.display = 'none';
  }
</script>
</body>
</html>
