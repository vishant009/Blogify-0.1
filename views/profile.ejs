<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title><%= profileUser.fullname %> | Profile | Blogify</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    body { background: #1a2634; color: #ecf0f1; font-family: Arial,sans-serif; margin:0;}
    .profile-header { text-align:center; padding:2rem 1rem 1rem 1rem; background:#2c3e50;}
    .profile-img { width:100px; height:100px; border-radius:50%; object-fit:cover; border:3px solid #f1c40f;}
    .profile-info { margin-top:1rem;}
    .profile-info h2 { color: #f1c40f; margin:0; }
    .profile-info p { color: #b2bec3; margin:0.5rem 0 0 0; }
    .profile-actions { margin-top:1rem; }
    .btn { background:#f1c40f; color:#1a2634; border:none; border-radius:5px; padding:0.6rem 1.2rem; font-weight:bold; cursor:pointer; margin:0.2rem;}
    .btn:hover { background:#e1b70e; }
    .profile-followers { margin-top:1rem; color:#f1c40f;}
    .blog-list { max-width:700px; margin:2rem auto; }
    .blog-card { background:#233146; border-radius:8px; margin-bottom:2rem; box-shadow:0 2px 8px rgba(0,0,0,0.18);}
    .blog-cover { width:100%; height:240px; border-radius:8px 8px 0 0; object-fit:cover;}
    .blog-content { padding:1.2rem; }
    .blog-title { font-size:1.3rem; color:#f1c40f; margin:0;}
    .blog-desc { margin:0.5rem 0 1rem 0; color:#b2bec3;}
    .blog-actions { display:flex; align-items:center; gap:1.5rem; }
    .like-btn, .comment-btn { background:none; border:none; color:#f1c40f; font-size:1.3rem; cursor:pointer; }
    .like-btn.liked { color:#e74c3c; }
    .blog-actions span { font-size:1rem; color:#f1c40f; }
    .comments-section { background:#1a2634; border-radius:0 0 8px 8px; padding:1rem; }
    .comment-form { display:flex; gap:0.5rem; margin-bottom:1rem; }
    .comment-form input, .comment-form textarea { flex:1; padding:0.6rem; border-radius:4px; border:none; background:#34495e; color:#ecf0f1; }
    .comment-form button { background:#27ae60; color:#fff; border:none; border-radius:4px; padding:.6rem 1.2rem; cursor:pointer;}
    .comment { margin-bottom:1rem; }
    .comment-user { font-weight: bold; color:#f1c40f; }
    .comment-body { margin:0.3rem 0 0.2rem 0; }
    .reply-btn { background:none; border:none; color:#00b894; font-size:0.9rem; cursor:pointer; }
    .reply-form { margin-left:2rem; margin-top:0.5rem; display:flex; gap:0.4rem;}
    .reply-form textarea { flex:1; }
    .reply { margin-left:2rem; background:#233146; padding:0.5rem 1rem; border-radius:5px;}
    /* Responsive */
    @media (max-width:800px) {
      .blog-list {padding:0 1rem;}
      .blog-cover {height:180px;}
    }
    @media (max-width:600px) {
      .blog-cover {height:120px;}
      .modal-content {padding:1rem;}
    }
  </style>
</head>
<body>
  <%- include('partials/header', { user }) %>
  <div class="profile-header">
    <img class="profile-img" src="<%= profileUser.profileImageURL %>" alt="<%= profileUser.fullname %>">
    <div class="profile-info">
      <h2><%= profileUser.fullname %></h2>
      <p><%= profileUser.bio || 'No bio yet.' %></p>
      <div class="profile-followers">
        <i class="fas fa-users"></i> <%= profileUser.followers.length %> Followers
      </div>
      <% if (user && user._id.toString() !== profileUser._id.toString()) { %>
        <div class="profile-actions">
          <% if (isFollowing) { %>
            <button class="btn" disabled>Following</button>
          <% } else { %>
            <form action="/profile/follow/<%= profileUser._id %>" method="POST" style="display:inline;">
              <button class="btn"><i class="fas fa-user-plus"></i> Follow</button>
            </form>
          <% } %>
        </div>
      <% } %>
    </div>
  </div>
  <!-- BLOG LIST -->
  <div class="blog-list">
    <% 
      const isSelf = user && (user._id.toString() === profileUser._id.toString());
      const canViewBlogs = isSelf || isFollowing || !profileUser.isPrivate;
    %>
    <% if (canViewBlogs) { %>
      <h2 style="color:#f1c40f; text-align:center; margin-bottom:2rem;">Blogs by <%= profileUser.fullname %></h2>
      <% if (blogs.length === 0) { %>
        <div style="text-align:center; color:#b2bec3;">No blogs yet.</div>
      <% } %>
      <% blogs.forEach(function(blog) { %>
        <div class="blog-card" id="blog-<%= blog._id %>">
          <% if (blog.coverImage) { %>
            <img class="blog-cover" src="<%= blog.coverImage %>" alt="Cover Image">
          <% } %>
          <div class="blog-content">
            <div class="blog-title"><%= blog.title %></div>
            <div class="blog-desc"><%= blog.description %></div>
            <div class="blog-actions">
              <form class="like-form" data-blogid="<%= blog._id %>" method="POST" action="/blog/<%= blog._id %>/like" style="display:inline;">
                <button type="button" class="like-btn <%= blog.likedByCurrentUser ? 'liked' : '' %>">
                  <i class="fa<%= blog.likedByCurrentUser ? 's' : 'r' %> fa-heart"></i>
                </button>
                <span><%= blog.likes.length %></span>
              </form>
              <button class="comment-btn" onclick="toggleComments('<%= blog._id %>')"><i class="far fa-comment"></i></button>
              <span><%= blog.comments.length %></span>
            </div>
          </div>
          <!-- COMMENTS SECTION -->
          <div class="comments-section" id="comments-<%= blog._id %>" style="display:none;">
            <form class="comment-form" data-blogid="<%= blog._id %>" method="POST" action="/comment/add">
              <input type="hidden" name="blogId" value="<%= blog._id %>">
              <textarea name="comment" rows="2" placeholder="Write a comment..." required></textarea>
              <button type="submit"><i class="fas fa-paper-plane"></i> Post</button>
            </form>
            <div class="comments-list">
              <% blog.comments.forEach(function(comment) { %>
                <div class="comment" id="comment-<%= comment._id %>">
                  <span class="comment-user"><img src="<%= comment.createdBy.profileImageURL %>" style="width:28px; height:28px; border-radius:50%; vertical-align:middle; margin-right:6px;"> <%= comment.createdBy.fullname %></span>
                  <div class="comment-body"><%= comment.body %></div>
                  <button class="reply-btn" onclick="showReplyForm('<%= comment._id %>')"><i class="fas fa-reply"></i> Reply</button>
                  <!-- REPLY FORM -->
                  <form class="reply-form" id="reply-form-<%= comment._id %>" data-commentid="<%= comment._id %>" method="POST" action="/comment/reply" style="display:none;">
                    <input type="hidden" name="blogId" value="<%= blog._id %>">
                    <input type="hidden" name="parent" value="<%= comment._id %>">
                    <textarea name="reply" rows="1" placeholder="Write a reply..." required></textarea>
                    <button type="submit"><i class="fas fa-paper-plane"></i></button>
                  </form>
                  <!-- REPLIES -->
                  <% if (comment.replies && comment.replies.length) { %>
                    <% comment.replies.forEach(function(reply) { %>
                      <div class="reply">
                        <span class="comment-user"><img src="<%= reply.createdBy.profileImageURL %>" style="width:22px; height:22px; border-radius:50%; vertical-align:middle; margin-right:4px;"> <%= reply.createdBy.fullname %></span>
                        <div class="comment-body"><%= reply.body %></div>
                      </div>
                    <% }) %>
                  <% } %>
                </div>
              <% }) %>
            </div>
          </div>
        </div>
      <% }) %>
    <% } else { %>
      <div style="text-align:center; margin:3rem 0; color:#ff7675; font-size:1.2rem;">
        <i class="fas fa-lock"></i> Only followers can view <%= profileUser.fullname %>'s blogs.
      </div>
    <% } %>
  </div>
  <script>
    // Toggle comments section
    function toggleComments(blogId) {
      var el = document.getElementById('comments-' + blogId);
      el.style.display = (el.style.display === 'none' || !el.style.display) ? 'block' : 'none';
    }
    // Show reply form
    function showReplyForm(commentId) {
      var form = document.getElementById('reply-form-' + commentId);
      form.style.display = (form.style.display === 'none' || !form.style.display) ? 'flex' : 'none';
    }
    // Like AJAX
    document.querySelectorAll('.like-form').forEach(form => {
      form.addEventListener('click', function(e) {
        if(e.target.closest('.like-btn')) {
          e.preventDefault();
          const blogId = form.getAttribute('data-blogid');
          fetch(`/blog/${blogId}/like`, { method:'POST', headers:{'X-Requested-With':'XMLHttpRequest'} })
          .then(r=>r.json()).then(data=>{
            if(data.success) {
              const btn = form.querySelector('.like-btn');
              btn.classList.toggle('liked', data.liked);
              btn.innerHTML = `<i class="fa${data.liked ? 's' : 'r'} fa-heart"></i>`;
              form.querySelector('span').textContent = data.likesCount;
            }
          });
        }
      });
    });
    // Comment AJAX
    document.querySelectorAll('.comment-form').forEach(form => {
      form.addEventListener('submit', function(e){
        e.preventDefault();
        const blogId = form.getAttribute('data-blogid');
        const textarea = form.querySelector('textarea');
        fetch(form.action, {
          method:'POST',
          headers:{'Content-Type':'application/x-www-form-urlencoded','X-Requested-With':'XMLHttpRequest'},
          body:`blogId=${blogId}&comment=${encodeURIComponent(textarea.value)}`
        }).then(r=>r.json()).then(data=>{
          if(data.success) location.reload(); // You can optimize to update DOM without reload.
        });
      });
    });
    // Reply AJAX
    document.querySelectorAll('.reply-form').forEach(form => {
      form.addEventListener('submit', function(e){
        e.preventDefault();
        const blogId = form.querySelector('input[name="blogId"]').value;
        const parent = form.querySelector('input[name="parent"]').value;
        const textarea = form.querySelector('textarea');
        fetch(form.action, {
          method:'POST',
          headers:{'Content-Type':'application/x-www-form-urlencoded','X-Requested-With':'XMLHttpRequest'},
          body:`blogId=${blogId}&parent=${parent}&reply=${encodeURIComponent(textarea.value)}`
        }).then(r=>r.json()).then(data=>{
          if(data.success) location.reload(); // You can optimize to update DOM without reload.
        });
      });
    });
  </script>
</body>
</html>
