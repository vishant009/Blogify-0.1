<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile | Blogifyer</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    :root {
      --primary: #1abc9c;
      --secondary: #34495e;
      --danger: #e74c3c;
      --success: #2ecc71;
      --profile-bg: #232c3e;
      --card-bg: #2c3e50;
      --border: #34495e;
      --text-main: #ecf0f1;
      --text-dim: #b2becd;
      --shadow: 0 4px 20px 0 rgba(31, 38, 135, 0.15);
      --hover-bg: #20252a;
    }
    body {
      background: linear-gradient(120deg, #181c20 0%, #202d3d 100%);
      color: var(--text-main);
      margin: 0;
      font-family: 'Segoe UI', Arial, sans-serif;
      min-height: 100vh;
    }
    .container {
      max-width: 900px;
      margin: 2.5rem auto 1rem;
      padding: 2.2rem 2rem 2.2rem;
      background: var(--profile-bg);
      border-radius: 1.2rem;
      box-shadow: var(--shadow);
    }
    .profile-header {
      display: flex;
      align-items: center;
      gap: 2.2rem;
      margin-bottom: 2.2rem;
    }
    .profile-avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: 4px solid var(--primary);
      object-fit: cover;
      box-shadow: 0 2px 12px rgba(0,0,0,0.19);
      background: #14171a;
    }
    .profile-details {
      flex: 1;
    }
    .profile-details h2 {
      font-size: 2rem;
      font-weight: 600;
      margin: 0 0 0.1em 0;
      color: var(--primary);
      letter-spacing: 1px;
    }
    .profile-details p {
      margin: 0.25em 0;
      color: var(--text-main);
      font-size: 1.08rem;
    }
    .profile-details .bio {
      color: var(--text-dim);
      font-style: italic;
      font-size: 1rem;
    }
    .profile-details .fstats {
      margin-top: 0.6em;
      font-size: 1rem;
      color: var(--text-main);
      display: flex;
      gap: 1.3em;
    }
    .profile-details .fstats span {
      cursor: pointer;
      color: var(--primary);
      text-decoration: underline dotted;
      outline: none;
    }
    .profile-actions {
      display: flex;
      gap: 1.2rem;
      margin-bottom: 2rem;
    }
    .follow-btn {
      padding: 0.6rem 1.4rem;
      border: none;
      border-radius: 6px;
      font-size: 1.03rem;
      background: var(--success);
      color: var(--text-main);
      font-weight: 600;
      cursor: pointer;
      transition: background 0.23s, transform 0.16s;
      display: flex;
      align-items: center;
      gap: 0.55em;
    }
    .follow-btn.unfollow {
      background: var(--danger);
    }
    .follow-btn.cancel {
      background: var(--danger);
    }
    .follow-btn.requested {
      background: #bdc3c7;
      cursor: not-allowed;
    }
    .follow-btn:hover { background: #219653; transform: scale(1.04);}
    .follow-btn.unfollow:hover { background: #c0392b;}
    .follow-btn.cancel:hover { background: #c0392b;}
    /* Popups: follower, following, comment, like */
    .popup,
    .modal {
      display: none;
      position: fixed;
      left: 0;
      bottom: 0;
      width: 100vw;
      background: #232b3d;
      z-index: 2200;
      border-top-left-radius: 1rem;
      border-top-right-radius: 1rem;
      box-shadow: 0 -15px 40px rgba(0,0,0,0.28);
      transition: transform 0.5s cubic-bezier(0.5,1.6,0.4,0.9);
      transform: translateY(100%);
      padding: 2.2rem 1.2rem 1.2rem;
      overflow-y: auto;
    }
    .popup.active,
    .modal.active {
      display: block;
      transform: translateY(0);
    }
    .followers-popup,
    .following-popup {
      height: 1600vh;
    }
    .modal[id^="commentsModal-"],
    .modal[id^="likesModal-"] {
      height: 1000vh;
      background: #232b3d;
      max-width: 100vw;
      border-radius: 1rem 1rem 0 0;
      left: 0;
      right: 0;
      margin: 0 auto;
      padding-bottom: 2rem;
    }
    .popup h3, .modal h3 {
      margin-top: 0;
      color: var(--primary);
      margin-bottom: 1.2rem;
      font-size: 1.25rem;
      letter-spacing: 0.5px;
    }
    .popup .close-btn, .modal .close-btn {
      position: absolute;
      top: 14px;
      right: 18px;
      background: none;
      border: none;
      color: var(--text-main);
      font-size: 1.33rem;
      cursor: pointer;
      transition: color 0.2s;
    }
    .popup .close-btn:hover, .modal .close-btn:hover {
      color: var(--danger);
    }
    .popup-list-user {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border);
    }
    .popup-list-user:last-child {
      border-bottom: none;
    }
    .popup-list-user img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      background: #181c20;
    }
    .popup-list-user a {
      color: var(--primary);
      text-decoration: none;
      font-size: 1.07rem;
      font-weight: 500;
      transition: text-decoration 0.15s;
    }
    .popup-list-user a:hover {
      text-decoration: underline;
    }
    .popup-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.48);
      z-index: 2000;
    }
    /* ... keep your other CSS and responsive ... */
  </style>
</head>
<body>
  <%- include('partials/header', { user }) %>
  <div class="container">
    <% if (success_msg) { %>
      <div class="alert alert-success"><i class="fas fa-check-circle"></i> <%= success_msg %></div>
    <% } %>
    <% if (error_msg) { %>
      <div class="alert alert-error"><i class="fas fa-exclamation-circle"></i> <%= error_msg %></div>
    <% } %>
    <% if (profileUser) { %>
      <div class="profile-header">
        <img class="profile-avatar" src="<%= profileUser.profileImageURL || '/default-profile.png' %>" alt="<%= profileUser.fullname %>'s Profile Image">
        <div class="profile-details">
          <h2><%= profileUser.fullname %></h2>
          <p class="bio"><i class="fas fa-info-circle"></i> <%= profileUser.bio || 'No bio provided.' %></p>
          <% if (canViewContent) { %>
            <div class="fstats">
              <span class="followers-toggle" tabindex="0" aria-label="View Followers">
                Followers: <%= profileUser.followers?.length || 0 %>
              </span>
              <span class="following-toggle" tabindex="0" aria-label="View Following">
                Following: <%= profileUser.following?.length || 0 %>
              </span>
              <span class="posts-count" aria-label="Total Posts">
                Posts: <%= blogs.length %>
              </span>
              <% if (user && user._id.toString() !== profileUser._id.toString()) { %>
                <span class="common-toggle" tabindex="0" aria-label="View Common Followers">
                  Common Followers: <%= commonFollowers.length %>
                </span>
              <% } %>
            </div>
          <% } %>
        </div>
      </div>
      <div class="profile-actions">
        <% if (user && user._id.toString() !== profileUser._id.toString()) { %>
          <% if (followStatus === 'requested') { %>
            <form action="/user/cancel-follow/<%= profileUser._id %>" method="POST" style="margin:0;">
              <button class="follow-btn cancel ajax-follow-btn" type="button" data-user-id="<%= profileUser._id %>" data-follow-status="requested">
                <i class="fas fa-user-times"></i> Cancel Request
              </button>
            </form>
          <% } else { %>
            <form action="<%= followStatus === 'following' ? `/user/unfollow/${profileUser._id}` : `/user/follow/${profileUser._id}` %>" method="POST" style="margin:0;">
              <button class="follow-btn <%= followStatus === 'following' ? 'following' : '' %> ajax-follow-btn" type="button" data-user-id="<%= profileUser._id %>" data-follow-status="<%= followStatus %>">
                <i class="fas <%= followStatus === 'following' ? 'fa-user-minus' : 'fa-user-plus' %>"></i>
                <%= followStatus === 'following' ? 'Unfollow' : 'Follow' %>
              </button>
            </form>
          <% } %>
        <% } %>
      </div>
      <!-- Followers Popup -->
      <div class="popup followers-popup">
        <h3><i class="fas fa-users"></i> Followers</h3>
        <button class="close-btn close-followers" aria-label="Close Followers">
          <i class="fas fa-arrow-left"></i>
        </button>
        <% if (!profileUser.followers || profileUser.followers.length === 0) { %>
          <p style="color:var(--text-dim);">No followers yet.</p>
        <% } else { %>
          <% profileUser.followers.forEach(follower => { %>
            <div class="popup-list-user">
              <img src="<%= follower.profileImageURL || '/default-profile.png' %>" alt="<%= follower.fullname %>'s Profile Image">
              <a href="/profile/<%= follower._id %>"><%= follower.fullname %></a>
              <% if (user && user._id.toString() === profileUser._id.toString() && follower._id.toString() !== user._id.toString()) { 
                const isFollowing = profileUser.following && profileUser.following.some(f => (f._id?.toString?.() || f.toString?.()) === follower._id.toString());
              %>
                <% if (isFollowing) { %>
                  <form action="/user/unfollow/<%= follower._id %>" method="POST" style="display:inline;">
                    <button class="follow-btn unfollow ajax-follow-btn" type="button" data-user-id="<%= follower._id %>" data-follow-status="following">
                      <i class="fas fa-user-minus"></i> Unfollow
                    </button>
                  </form>
                <% } else { %>
                  <form action="/user/follow/<%= follower._id %>" method="POST" style="display:inline;">
                    <button class="follow-btn ajax-follow-btn" type="button" data-user-id="<%= follower._id %>" data-follow-status="follow">
                      <i class="fas fa-user-plus"></i> Follow Back
                    </button>
                  </form>
                <% } %>
              <% } %>
            </div>
          <% }) %>
        <% } %>
      </div>
      <!-- Following Popup -->
      <div class="popup following-popup">
        <h3><i class="fas fa-user-friends"></i> Following</h3>
        <button class="close-btn close-following" aria-label="Close Following">
          <i class="fas fa-arrow-left"></i>
        </button>
        <% if (!profileUser.following || profileUser.following.length === 0) { %>
          <p style="color:var(--text-dim);">Not following anyone yet.</p>
        <% } else { %>
          <% profileUser.following.forEach(following => { %>
            <div class="popup-list-user">
              <img src="<%= following.profileImageURL || '/default-profile.png' %>" alt="<%= following.fullname %>'s Profile Image">
              <a href="/profile/<%= following._id %>"><%= following.fullname %></a>
              <% if (user && user._id.toString() === profileUser._id.toString() && following._id.toString() !== user._id.toString()) { 
                const isFollower = profileUser.followers && profileUser.followers.some(f => (f._id?.toString?.() || f.toString?.()) === following._id.toString());
              %>
                <form action="/user/unfollow/<%= following._id %>" method="POST" style="display:inline;">
                  <button class="follow-btn unfollow ajax-follow-btn" type="button" data-user-id="<%= following._id %>" data-follow-status="following">
                    <i class="fas fa-user-minus"></i> Unfollow
                  </button>
                </form>
                <% if (!isFollower) { %>
                  <form action="/user/follow/<%= following._id %>" method="POST" style="display:inline;">
                    <button class="follow-btn ajax-follow-btn" type="button" data-user-id="<%= following._id %>" data-follow-status="follow">
                      <i class="fas fa-user-plus"></i> Follow
                    </button>
                  </form>
                <% } %>
              <% } %>
            </div>
          <% }) %>
        <% } %>
      </div>
      <!-- Common Followers Popup (unchanged) -->
      <div class="popup common-popup">
        <h3><i class="fas fa-user-group"></i> Common Followers</h3>
        <button class="close-btn close-common" aria-label="Close Common Followers">
          <i class="fas fa-arrow-left"></i>
        </button>
        <% if (commonFollowers.length === 0) { %>
          <p style="color:var(--text-dim);">No common followers.</p>
        <% } else { %>
          <% commonFollowers.forEach(follower => { %>
            <div class="popup-list-user">
              <img src="<%= follower.profileImageURL || '/default-profile.png' %>" alt="<%= follower.fullname %>'s Profile Image">
              <a href="/profile/<%= follower._id %>"><%= follower.fullname %></a>
            </div>
          <% }) %>
        <% } %>
      </div>
      <!-- ...rest of your content (blogs, modals, JS) unchanged ... -->
      <%- /* KEEP REST OF THE FILE JS AND BLOGS SECTION AS IT WAS, NO UI CHANGE */ %>
      <% if (canViewContent) { %>
        <div class="blogs-section">
          <!-- ...blogs render here... -->
        </div>
      <% } else { %>
        <div class="alert alert-error" style="margin-top:2em;"><i class="fa fa-lock"></i> This account is private. Only followers can see blogs.</div>
      <% } %>
    <% } else { %>
      <div class="alert alert-error">Profile not found.</div>
    <% } %>
  </div>
  <div class="popup-overlay"></div>
  <script>
    // ...keep all your existing JS unchanged...
    // Popup logic (followers, following, common)
    document.addEventListener('DOMContentLoaded', () => {
      const followersToggle = document.querySelector('.followers-toggle');
      const followingToggle = document.querySelector('.following-toggle');
      const commonToggle = document.querySelector('.common-toggle');
      const followersPopup = document.querySelector('.followers-popup');
      const followingPopup = document.querySelector('.following-popup');
      const commonPopup = document.querySelector('.common-popup');
      const closeFollowers = document.querySelector('.close-followers');
      const closeFollowing = document.querySelector('.close-following');
      const closeCommon = document.querySelector('.close-common');
      const overlay = document.querySelector('.popup-overlay');
      const showPopup = (popup) => {
        if (popup) {
          popup.style.display = 'block';
          overlay.style.display = 'block';
          setTimeout(() => {
            popup.classList.add('active');
          }, 8);
          popup.focus();
        }
      };
      const hidePopup = (popup) => {
        if (popup) {
          popup.classList.remove('active');
          setTimeout(() => {
            popup.style.display = 'none';
            overlay.style.display = 'none';
          }, 400);
        }
      };
      if (followersToggle && followersPopup) {
        followersToggle.addEventListener('click', () => showPopup(followersPopup));
        followersToggle.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            showPopup(followersPopup);
          }
        });
      }
      if (closeFollowers && followersPopup) {
        closeFollowers.addEventListener('click', () => hidePopup(followersPopup));
      }
      if (followingToggle && followingPopup) {
        followingToggle.addEventListener('click', () => showPopup(followingPopup));
        followingToggle.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            showPopup(followingPopup);
          }
        });
      }
      if (closeFollowing && followingPopup) {
        closeFollowing.addEventListener('click', () => hidePopup(followingPopup));
      }
      if (commonToggle && commonPopup) {
        commonToggle.addEventListener('click', () => showPopup(commonPopup));
        commonToggle.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            showPopup(commonPopup);
          }
        });
      }
      if (closeCommon && commonPopup) {
        closeCommon.addEventListener('click', () => hidePopup(commonPopup));
      }
      overlay.addEventListener('click', () => {
        hidePopup(followersPopup);
        hidePopup(followingPopup);
        hidePopup(commonPopup);
      });
      window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          hidePopup(followersPopup);
          hidePopup(followingPopup);
          hidePopup(commonPopup);
        }
      });
      // AJAX for follow/unfollow/cancel (for the popup buttons)
      document.querySelectorAll('.ajax-follow-btn').forEach(button => {
        button.addEventListener('click', async () => {
          const userId = button.dataset.userId;
          let currentStatus = button.dataset.followStatus;
          let endpoint = '';
          if (currentStatus === 'following') {
            endpoint = `/user/unfollow/${userId}`;
          } else if (currentStatus === 'requested') {
            endpoint = `/user/cancel-follow/${userId}`;
          } else {
            endpoint = `/user/follow/${userId}`;
          }
          try {
            const response = await fetch(endpoint, {
              method: 'POST',
              headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json'
              }
            });
            if (response.ok) {
              const data = await response.json();
              currentStatus = data.newStatus;
              button.dataset.followStatus = currentStatus;
              button.classList.remove('following', 'requested', 'cancel');
              if (currentStatus === 'following') {
                button.innerHTML = '<i class="fas fa-user-minus"></i> Unfollow';
                button.classList.add('following');
              } else if (currentStatus === 'requested') {
                button.innerHTML = '<i class="fas fa-user-times"></i> Cancel Request';
                button.classList.add('requested', 'cancel');
              } else {
                button.innerHTML = '<i class="fas fa-user-plus"></i> Follow';
              }
              location.reload();
            } else {
              console.error('Failed to update follow status');
            }
          } catch (error) {
            console.error('Error:', error);
          }
        });
      });
    });
  </script>
</body>
</html>
