<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('./partials/head') %>
  <title><%= profileUser.fullname %>'s Profile</title>
  <style>
    .blog-card { position: relative; }
    .options-menu { position: absolute; top: 1rem; right: 1rem; }
    .options-button { background: none; border: none; font-size: 1.5rem; cursor: pointer; line-height: 1; padding: 0 0.5rem; }
    .dropdown-menu { display: none; position: absolute; right: 0; background-color: #fff; min-width: 160px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 1; border-radius: 0.375rem; }
    .dropdown-menu a, .dropdown-menu button { color: black; padding: 12px 16px; text-decoration: none; display: block; width: 100%; text-align: left; border: none; background: none; }
    .dropdown-menu a:hover, .dropdown-menu button:hover { background-color: #f1f1f1; }
    .show { display: block; }
    .comment-actions { visibility: hidden; opacity: 0; transition: opacity 0.2s; }
    .comment-container:hover .comment-actions { visibility: visible; opacity: 1; }
  </style>
</head>
<body>
  <%- include('./partials/nav') %>

  <div class="container mt-4">
    <h4>Blogs by <%= profileUser.fullname %></h4>
    <hr>
    <% if (blogs && blogs.length > 0) { %>
      <% blogs.forEach(blog => { %>
        <div class="card mb-3 blog-card">
          <div class="card-body">
            <div class="options-menu">
              <button class="options-button" onclick="toggleMenu('<%= blog._id %>')">â‹®</button>
              <div id="dropdown-<%= blog._id %>" class="dropdown-menu">
                <a href="#" onclick="shareBlog('<%= blog._id %>', '<%= blog.title %>')">Share Blog</a>
                <% if (user && user._id.equals(blog.createdBy._id)) { %>
                  <form action="/blog/<%= blog._id %>?_method=DELETE" method="POST" onsubmit="return confirm('Are you sure you want to delete this blog?');">
                    <button type="submit" class="text-danger">Delete Blog</button>
                  </form>
                <% } %>
              </div>
            </div>
            <h5 class="card-title"><%= blog.title %></h5>
            <p class="card-text"><%= blog.body %></p>
            <h6>Comments</h6>
            <% blog.comments.forEach(comment => { %>
              <div class="comment-container border-start border-2 ps-2 mb-2">
                <strong><%= comment.createdBy.fullname %>:</strong>
                <span><%= comment.content %></span>
                <% if (user && user._id.equals(blog.createdBy._id)) { %>
                  <form action="/comment/<%= comment._id %>?_method=DELETE" method="POST" class="d-inline comment-actions">
                    <button type="submit" class="btn btn-sm btn-outline-danger p-0 px-1" title="Delete Comment">&times;</button>
                  </form>
                <% } %>
              </div>
            <% }) %>
          </div>
        </div>
      <% }) %>
    <% } else { %>
      <p><%= profileUser.fullname %> has not posted any blogs yet.</p>
    <% } %>
  </div>

  <%- include('./partials/scripts') %>
  <script>
    function toggleMenu(blogId) { document.getElementById(`dropdown-${blogId}`).classList.toggle("show"); }
    window.onclick = function(event) {
      if (!event.target.matches('.options-button')) {
        document.querySelectorAll('.dropdown-menu.show').forEach(menu => menu.classList.remove('show'));
      }
    }
    async function shareBlog(blogId, title) {
      const shareData = { title: title, text: `Check out: "${title}"`, url: `${window.location.origin}/blog/${blogId}` };
      try {
        if (navigator.share) await navigator.share(shareData);
        else { await navigator.clipboard.writeText(shareData.url); alert('Link copied!'); }
      } catch (err) { console.error("Error sharing:", err); }
    }
  </script>
</body>
</html>
