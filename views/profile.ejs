<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile | Blogifyer</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    /* ... full style content as in your base file ... */
    /* (preserve all your original styles) */
  </style>
</head>
<body>
  <%- include('partials/header', { user }) %>
  <div class="container">
    <% if (success_msg) { %>
      <div class="alert alert-success"><i class="fas fa-check-circle"></i> <%= success_msg %></div>
    <% } %>
    <% if (error_msg) { %>
      <div class="alert alert-error"><i class="fas fa-exclamation-circle"></i> <%= error_msg %></div>
    <% } %>
    <% if (profileUser) { %>
      <div class="profile-header">
        <img class="profile-avatar" src="<%= profileUser.profileImageURL || '/default-profile.png' %>" alt="<%= profileUser.fullname %>'s Profile Image">
        <div class="profile-details">
          <h2><%= profileUser.fullname %></h2>
          <p class="bio"><i class="fas fa-info-circle"></i> <%= profileUser.bio || 'No bio provided.' %></p>
          <div class="fstats">
            <span class="followers-toggle" tabindex="0" aria-label="View Followers">
              Followers: <%= profileUser.followers?.length || 0 %>
            </span>
            <span class="following-toggle" tabindex="0" aria-label="View Following">
              Following: <%= profileUser.following?.length || 0 %>
            </span>
            <% if (user && user._id.toString() !== profileUser._id.toString()) { %>
              <span class="common-toggle" tabindex="0" aria-label="View Common Followers">
                Common Followers: <%= commonFollowers.length %>
              </span>
            <% } %>
          </div>
        </div>
      </div>
      <div class="profile-actions">
        <% if (user && user._id.toString() !== profileUser._id.toString()) { %>
          <% if (followStatus === 'requested') { %>
            <form action="/user/cancel-follow/<%= profileUser._id %>" method="POST" style="margin:0;">
              <button class="follow-btn cancel" type="submit">
                <i class="fas fa-user-times"></i> Cancel Request
              </button>
            </form>
          <% } else { %>
            <form action="<%= followStatus === 'following' ? `/user/unfollow/${profileUser._id}` : `/user/follow/${profileUser._id}` %>" method="POST" style="margin:0;">
              <button class="follow-btn <%= followStatus === 'following' ? 'unfollow' : '' %>" type="submit">
                <i class="fas <%= followStatus === 'following' ? 'fa-user-minus' : 'fa-user-plus' %>"></i>
                <%= followStatus === 'following' ? 'Unfollow' : 'Follow' %>
              </button>
            </form>
          <% } %>
        <% } %>
      </div>
      <!-- Followers, Following, Common popups (unchanged) -->
      <div class="popup followers-popup">
        <h3><i class="fas fa-users"></i> Followers</h3>
        <button class="close-btn close-followers" aria-label="Close Followers">
          <i class="fas fa-times"></i>
        </button>
        <% if (!profileUser.followers || profileUser.followers.length === 0) { %>
          <p style="color:var(--text-dim);">No followers yet.</p>
        <% } else { %>
          <% profileUser.followers.forEach(follower => { %>
            <div class="popup-list-user">
              <img src="<%= follower.profileImageURL || '/default-profile.png' %>" alt="<%= follower.fullname %>'s Profile Image">
              <a href="/profile/<%= follower._id %>"><%= follower.fullname %></a>
            </div>
          <% }) %>
        <% } %>
      </div>
      <div class="popup following-popup">
        <h3><i class="fas fa-user-friends"></i> Following</h3>
        <button class="close-btn close-following" aria-label="Close Following">
          <i class="fas fa-times"></i>
        </button>
        <% if (!profileUser.following || profileUser.following.length === 0) { %>
          <p style="color:var(--text-dim);">Not following anyone yet.</p>
        <% } else { %>
          <% profileUser.following.forEach(following => { %>
            <div class="popup-list-user">
              <img src="<%= following.profileImageURL || '/default-profile.png' %>" alt="<%= following.fullname %>'s Profile Image">
              <a href="/profile/<%= following._id %>"><%= following.fullname %></a>
            </div>
          <% }) %>
        <% } %>
      </div>
      <div class="popup common-popup">
        <h3><i class="fas fa-user-group"></i> Common Followers</h3>
        <button class="close-btn close-common" aria-label="Close Common Followers">
          <i class="fas fa-times"></i>
        </button>
        <% if (commonFollowers.length === 0) { %>
          <p style="color:var(--text-dim);">No common followers.</p>
        <% } else { %>
          <% commonFollowers.forEach(follower => { %>
            <div class="popup-list-user">
              <img src="<%= follower.profileImageURL || '/default-profile.png' %>" alt="<%= follower.fullname %>'s Profile Image">
              <a href="/profile/<%= follower._id %>"><%= follower.fullname %></a>
            </div>
          <% }) %>
        <% } %>
      </div>
      <% // --- BLOG VISIBILITY LOGIC --- %>
      <% if (
        !profileUser.isPrivate ||
        (user && user._id.toString() === profileUser._id.toString()) ||
        (user && profileUser.isPrivate && profileUser.followers.some(f => f.toString() === user._id.toString()))
      ) { %>
        <div class="blogs-section">
          <h2><i class="fas fa-blog"></i> Blogs by <%= profileUser.fullname %></h2>
          <% if (blogs && blogs.length > 0) { %>
            <% blogs.forEach(blog => { %>
              <div class="blog-card">
                <% if (blog.coverImage && blog.coverImage.length > 0) { %>
                  <img class="blog-cover-image" src="<%= blog.coverImage %>" alt="Blog Cover Image" loading="lazy">
                <% } else { %>
                  <img class="blog-cover-image" src="/default-blog-cover.jpg" alt="Blog Cover Image" loading="lazy">
                <% } %>
                <div class="blog-card-main">
                  <div class="blog-card-title">
                    <a href="/blog/<%= blog._id %>"><%= blog.title %></a>
                  </div>
                  <div class="blog-card-body">
                    <%= blog.body && blog.body.length > 120 ? blog.body.substring(0, 120) + '...' : blog.body %>
                  </div>
                  <div class="blog-actions" style="display:flex;gap:1.1em;margin-top:.7em;">
                    <form action="/blog/like/<%= blog._id %>" method="POST" style="display:inline;">
                      <button class="like-btn" type="submit" style="background:none;border:none;color:var(--text-dim);font-size:1.08em;cursor:pointer;">
                        <i class="fa<%= blog.likes && blog.likes.some(l => l._id.toString() === (user && user._id.toString())) ? 's' : 'r' %> fa-heart" style="color:<%= blog.likes && blog.likes.some(l => l._id.toString() === (user && user._id.toString())) ? 'var(--danger)' : 'var(--text-dim)' %>"></i>
                        <%= blog.likes ? blog.likes.length : 0 %>
                      </button>
                    </form>
                    <a href="/blog/<%= blog._id %>#comments" class="comment-btn" style="color:var(--text-dim);text-decoration:none;font-size:1.08em;">
                      <i class="fa-regular fa-comment"></i>
                      <%= blog.totalComments || 0 %>
                    </a>
                  </div>
                </div>
                <div class="blog-menu">
                  <button class="dots-btn" type="button" tabindex="0" aria-label="Blog Options" data-blogid="<%= blog._id %>">
                    <i class="fas fa-ellipsis-v"></i>
                  </button>
                  <div class="dropdown-menu" id="dropdown-<%= blog._id %>">
                    <% if (user && blog.createdBy && user._id.toString() === blog.createdBy._id.toString()) { %>
                      <form action="/blog/<%= blog._id %>?_method=DELETE" method="POST" onsubmit="return confirm('Are you sure you want to delete this blog?');" style="margin:0;">
                        <button type="submit"><i class="fas fa-trash"></i> Delete Blog</button>
                      </form>
                      <button type="button" onclick="navigator.clipboard.writeText(window.location.origin + '/blog/<%= blog._id %>');alert('Blog link copied!');"><i class="fas fa-share"></i> Share Blog</button>
                    <% } else { %>
                      <button type="button" onclick="navigator.clipboard.writeText(window.location.origin + '/blog/<%= blog._id %>');alert('Blog link copied!');"><i class="fas fa-share"></i> Share Blog</button>
                    <% } %>
                  </div>
                </div>
              </div>
            <% }) %>
          <% } else { %>
            <p style="color:var(--text-dim);">No blogs yet.</p>
          <% } %>
        </div>
      <% } else { %>
        <div class="alert alert-error" style="margin-top:2em;"><i class="fa fa-lock"></i> This account is private. Only followers can see blogs.</div>
      <% } %>
    <% } else { %>
      <div class="alert alert-error">Profile not found.</div>
    <% } %>
  </div>
  <div class="popup-overlay"></div>
  <script>
    // 3-dot blog menu logic
    document.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('.dots-btn').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
          e.stopPropagation();
          var blogId = btn.getAttribute('data-blogid');
          var dropdown = document.getElementById('dropdown-' + blogId);
          document.querySelectorAll('.dropdown-menu').forEach(function(menu) {
            if (menu !== dropdown) menu.style.display = 'none';
          });
          dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        });
      });
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.blog-menu')) {
          document.querySelectorAll('.dropdown-menu').forEach(function(menu) {
            menu.style.display = 'none';
          });
        }
      });
      window.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          document.querySelectorAll('.dropdown-menu').forEach(function(menu) {
            menu.style.display = 'none';
          });
        }
      });
      const followersToggle = document.querySelector('.followers-toggle');
      const followingToggle = document.querySelector('.following-toggle');
      const commonToggle = document.querySelector('.common-toggle');
      const followersPopup = document.querySelector('.followers-popup');
      const followingPopup = document.querySelector('.following-popup');
      const commonPopup = document.querySelector('.common-popup');
      const closeFollowers = document.querySelector('.close-followers');
      const closeFollowing = document.querySelector('.close-following');
      const closeCommon = document.querySelector('.close-common');
      const overlay = document.querySelector('.popup-overlay');
      const showPopup = (popup) => {
        if (popup) {
          popup.style.display = 'block';
          overlay.style.display = 'block';
          popup.focus();
        }
      };
      const hidePopup = (popup) => {
        if (popup) popup.style.display = 'none';
        overlay.style.display = 'none';
      };
      if (followersToggle && followersPopup) {
        followersToggle.addEventListener('click', () => showPopup(followersPopup));
        followersToggle.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            showPopup(followersPopup);
          }
        });
      }
      if (closeFollowers && followersPopup) {
        closeFollowers.addEventListener('click', () => hidePopup(followersPopup));
      }
      if (followingToggle && followingPopup) {
        followingToggle.addEventListener('click', () => showPopup(followingPopup));
        followingToggle.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            showPopup(followingPopup);
          }
        });
      }
      if (closeFollowing && followingPopup) {
        closeFollowing.addEventListener('click', () => hidePopup(followingPopup));
      }
      if (commonToggle && commonPopup) {
        commonToggle.addEventListener('click', () => showPopup(commonPopup));
        commonToggle.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            showPopup(commonPopup);
          }
        });
      }
      if (closeCommon && commonPopup) {
        closeCommon.addEventListener('click', () => hidePopup(commonPopup));
      }
      overlay.addEventListener('click', () => {
        hidePopup(followersPopup);
        hidePopup(followingPopup);
        hidePopup(commonPopup);
      });
      window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          hidePopup(followersPopup);
          hidePopup(followingPopup);
          hidePopup(commonPopup);
        }
      });
    });
  </script>
</body>
</html>
