<!-- views/profile.ejs -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile | Blogifyer</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    :root {
      --primary: #1abc9c;
      --secondary: #34495e;
      --danger: #e74c3c;
      --success: #2ecc71;
      --profile-bg: #232c3e;
      --card-bg: #2c3e50;
      --border: #34495e;
      --text-main: #ecf0f1;
      --text-dim: #b2becd;
      --shadow: 0 4px 20px 0 rgba(31, 38, 135, 0.15);
    }
    body {
      background: linear-gradient(120deg, #181c20 0%, #202d3d 100%);
      color: var(--text-main);
      margin: 0;
      font-family: 'Segoe UI', Arial, sans-serif;
      min-height: 100vh;
    }
    .container {
      max-width: 900px;
      margin: 2.5rem auto 1rem;
      padding: 2.2rem 2rem 2.2rem;
      background: var(--profile-bg);
      border-radius: 1.2rem;
      box-shadow: var(--shadow);
    }
    .profile-header {
      display: flex;
      align-items: center;
      gap: 2.2rem;
      margin-bottom: 2.2rem;
    }
    .profile-avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: 4px solid var(--primary);
      object-fit: cover;
      box-shadow: 0 2px 12px rgba(0,0,0,0.19);
      background: #14171a;
    }
    .profile-details {
      flex: 1;
    }
    .profile-details h2 {
      font-size: 2rem;
      font-weight: 600;
      margin: 0 0 0.1em 0;
      color: var(--primary);
      letter-spacing: 1px;
    }
    .profile-details p {
      margin: 0.25em 0;
      color: var(--text-main);
      font-size: 1.08rem;
    }
    .profile-details .bio {
      color: var(--text-dim);
      font-style: italic;
      font-size: 1rem;
    }
    .profile-details .fstats {
      margin-top: 0.6em;
      font-size: 1rem;
      color: var(--text-main);
      display: flex;
      gap: 1.3em;
    }
    .profile-details .fstats span {
      cursor: pointer;
      color: var(--primary);
      text-decoration: underline dotted;
      outline: none;
    }
    .profile-actions {
      display: flex;
      gap: 1.2rem;
      margin-bottom: 2rem;
    }
    .follow-btn {
      padding: 0.6rem 1.4rem;
      border: none;
      border-radius: 6px;
      font-size: 1.03rem;
      background: var(--success);
      color: var(--text-main);
      font-weight: 600;
      cursor: pointer;
      transition: background 0.23s, transform 0.16s;
      display: flex;
      align-items: center;
      gap: 0.55em;
    }
    .follow-btn.unfollow {
      background: var(--danger);
    }
    .follow-btn.cancel {
      background: var(--danger);
    }
    .follow-btn.requested {
      background: #bdc3c7;
      cursor: not-allowed;
    }
    .follow-btn:hover { background: #219653; transform: scale(1.04);}
    .follow-btn.unfollow:hover { background: #c0392b;}
    .follow-btn.cancel:hover { background: #c0392b;}
    /* Popups */
    .popup {
      display: none;
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: var(--card-bg);
      padding: 2.2rem 1.2rem 1.2rem;
      border-radius: 1rem;
      box-shadow: 0 15px 40px rgba(0,0,0,0.28);
      z-index: 2200;
      min-width: 320px;
      max-width: 98vw;
      max-height: 75vh;
      overflow-y: auto;
      animation: fadeIn 0.3s;
    }
    .popup h3 {
      margin-top: 0; color: var(--primary); margin-bottom: 1.2rem;
      font-size: 1.25rem; letter-spacing: .5px;
    }
    .popup .close-btn {
      position: absolute;
      top: 14px; right: 18px;
      background: none;
      border: none;
      color: var(--text-main);
      font-size: 1.33rem;
      cursor: pointer;
      transition: color 0.2s;
    }
    .popup .close-btn:hover { color: var(--danger);}
    .popup-list-user {
      display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; padding: 0.5rem 0;
      border-bottom: 1px solid var(--border);
    }
    .popup-list-user:last-child { border-bottom: none;}
    .popup-list-user img {
      width: 40px; height: 40px; border-radius: 50%;
      object-fit: cover; background: #181c20;
    }
    .popup-list-user a {
      color: var(--primary);
      text-decoration: none;
      font-size: 1.07rem;
      font-weight: 500;
      transition: text-decoration 0.15s;
    }
    .popup-list-user a:hover { text-decoration: underline;}
    .popup-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.48);
      z-index: 2000;
    }
    /* Blog cards */
    .blogs-section {
      margin-top: 2.2rem;
    }
    .blogs-section h2 {
      color: var(--primary);
      font-size: 1.3rem;
      margin-bottom: 1.1rem;
      letter-spacing: 1px;
      font-weight: 600;
    }
    .blog-card {
      background: var(--card-bg);
      border-radius: 0.8rem;
      padding: 1.4rem 1rem 1.1rem;
      box-shadow: 0 4px 24px 0 rgba(31,38,135,0.07);
      margin-bottom: 1.2rem;
      border: 1.3px solid var(--border);
      transition: box-shadow 0.2s, transform 0.15s;
      position: relative;
      display: flex;
      gap: 1.1rem;
      align-items: flex-start;
      min-height: 100px;
    }
    .blog-card:hover {
      box-shadow: 0 10px 35px 0 rgba(26,188,156,0.10);
      transform: scale(1.015);
    }
    .blog-cover-image {
      width: 110px;
      height: 80px;
      object-fit: cover;
      border-radius: 0.5rem;
      background: #232c3e;
      border: 1px solid var(--border);
      box-shadow: 0 2px 8px 0 rgba(31,38,135,0.09);
      flex-shrink: 0;
      display: block;
    }
    .blog-card-main {
      flex: 1;
      min-width: 0;
    }
    .blog-card-title {
      font-size: 1.15rem;
      font-weight: bold;
      margin-bottom: 0.4rem;
      color: var(--primary);
    }
    .blog-card-title a { color: inherit; text-decoration: none;}
    .blog-card-title a:hover { text-decoration: underline;}
    .blog-card-body {
      color: var(--text-dim);
      font-size: 1.03rem;
      margin-bottom: 0.6rem;
      line-height: 1.6;
      word-break: break-word;
    }
    /* 3-dots menu */
    .blog-menu {
      position: absolute;
      top: 16px;
      right: 20px;
      z-index: 10;
    }
    .dots-btn {
      background: none;
      border: none;
      color: var(--text-dim);
      font-size: 1.45rem;
      cursor: pointer;
      padding: 2px 8px;
      border-radius: 50%;
      transition: background 0.18s;
    }
    .dots-btn:focus,
    .dots-btn:hover {
      background: rgba(200,200,200,0.07);
      color: var(--primary);
      outline: none;
    }
    .dropdown-menu {
      display: none;
      position: absolute;
      top: 28px;
      right: 0;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 0.6rem;
      box-shadow: 0 2px 10px 0 rgba(31,38,135,0.13);
      min-width: 120px;
      z-index: 1001;
      padding: 0.3rem 0.1rem;
    }
    .dropdown-menu button {
      background: none;
      border: none;
      color: var(--danger);
      font-size: 1rem;
      text-align: left;
      width: 100%;
      padding: 0.6rem 1rem;
      cursor: pointer;
      border-radius: 0.4rem;
      transition: background 0.15s;
    }
    .dropdown-menu button:hover {
      background: rgba(231,76,60,0.09);
    }
    /* Alerts */
    .alert {
      padding: 1rem;
      border-radius: 7px;
      margin-bottom: 1.3rem;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }
    .alert-success { background: rgba(46,204,113,0.08); color: var(--success);}
    .alert-error { background: rgba(231,76,60,0.09); color: var(--danger);}
    @keyframes fadeIn {
      from { opacity: 0; transform: translate(-50%, -60%);}
      to { opacity: 1; transform: translate(-50%, -50%);}
    }
    @media (max-width: 900px) {
      .container { padding: 1.2rem 0.4rem; }
      .profile-header { gap: 1rem; }
      .blog-card { flex-direction: column; gap: 0.7rem; min-height: unset;}
      .blog-cover-image { width: 100%; height: 145px; margin: 0 0 1rem 0;}
      .blog-card-main { min-width: 0; }
    }
    @media (max-width: 600px) {
      .container { padding: 0.4rem 0.1rem;}
      .profile-header { flex-direction: column; align-items: flex-start; gap: 1.2rem;}
      .profile-avatar { width: 80px; height: 80px;}
      .blogs-section { margin-top: 1.2rem;}
      .blog-card { flex-direction: column; gap: 0.5rem;}
      .blog-cover-image { min-width: 100%; max-width: 100%; height: 140px;}
      .blog-menu { right: 10px; top: 10px;}
    }
  </style>
</head>
<body>
  <%- include('partials/header', { user }) %>
  <div class="container">
    <% if (success_msg) { %>
      <div class="alert alert-success"><i class="fas fa-check-circle"></i> <%= success_msg %></div>
    <% } %>
    <% if (error_msg) { %>
      <div class="alert alert-error"><i class="fas fa-exclamation-circle"></i> <%= error_msg %></div>
    <% } %>
    <% if (profileUser) { %>
      <div class="profile-header">
        <img class="profile-avatar" src="<%= profileUser.profileImageURL || '/default-profile.png' %>" alt="<%= profileUser.fullname %>'s Profile Image">
        <div class="profile-details">
          <h2><%= profileUser.fullname %></h2>
          <!-- Email removed as per requirements -->
          <p class="bio"><i class="fas fa-info-circle"></i> <%= profileUser.bio || 'No bio provided.' %></p>
          <div class="fstats">
            <span class="followers-toggle" tabindex="0" aria-label="View Followers">
              Followers: <%= profileUser.followers?.length || 0 %>
            </span>
            <span class="following-toggle" tabindex="0" aria-label="View Following">
              Following: <%= profileUser.following?.length || 0 %>
            </span>
            <% if (user && user._id.toString() !== profileUser._id.toString()) { %>
              <span class="common-toggle" tabindex="0" aria-label="View Common Followers">
                Common Followers: <%= commonFollowers.length %>
              </span>
            <% } %>
          </div>
        </div>
      </div>
      <div class="profile-actions">
        <% if (user && user._id.toString() !== profileUser._id.toString()) { %>
          <% if (followStatus === 'requested') { %>
            <form action="/user/cancel-follow/<%= profileUser._id %>" method="POST" style="margin:0;">
              <button class="follow-btn cancel" type="submit">
                <i class="fas fa-user-times"></i> Cancel Request
              </button>
            </form>
          <% } else { %>
            <form action="<%= followStatus === 'following' ? `/user/unfollow/${profileUser._id}` : `/user/follow/${profileUser._id}` %>" method="POST" style="margin:0;">
              <button class="follow-btn <%= followStatus === 'following' ? 'unfollow' : '' %>" type="submit">
                <i class="fas <%= followStatus === 'following' ? 'fa-user-minus' : 'fa-user-plus' %>"></i>
                <%= followStatus === 'following' ? 'Unfollow' : 'Follow' %>
              </button>
            </form>
          <% } %>
        <% } %>
      </div>
      <!-- Followers Popup -->
      <div class="popup followers-popup">
        <h3><i class="fas fa-users"></i> Followers</h3>
        <button class="close-btn close-followers" aria-label="Close Followers">
          <i class="fas fa-times"></i>
        </button>
        <% if (!profileUser.followers || profileUser.followers.length === 0) { %>
          <p style="color:var(--text-dim);">No followers yet.</p>
        <% } else { %>
          <% profileUser.followers.forEach(follower => { %>
            <div class="popup-list-user">
              <img src="<%= follower.profileImageURL || '/default-profile.png' %>" alt="<%= follower.fullname %>'s Profile Image">
              <a href="/profile/<%= follower._id %>"><%= follower.fullname %></a>
            </div>
          <% }) %>
        <% } %>
      </div>
      <!-- Following Popup -->
      <div class="popup following-popup">
        <h3><i class="fas fa-user-friends"></i> Following</h3>
        <button class="close-btn close-following" aria-label="Close Following">
          <i class="fas fa-times"></i>
        </button>
        <% if (!profileUser.following || profileUser.following.length === 0) { %>
          <p style="color:var(--text-dim);">Not following anyone yet.</p>
        <% } else { %>
          <% profileUser.following.forEach(following => { %>
            <div class="popup-list-user">
              <img src="<%= following.profileImageURL || '/default-profile.png' %>" alt="<%= following.fullname %>'s Profile Image">
              <a href="/profile/<%= following._id %>"><%= following.fullname %></a>
            </div>
          <% }) %>
        <% } %>
      </div>
      <!-- Common Followers Popup -->
      <div class="popup common-popup">
        <h3><i class="fas fa-user-group"></i> Common Followers</h3>
        <button class="close-btn close-common" aria-label="Close Common Followers">
          <i class="fas fa-times"></i>
        </button>
        <% if (commonFollowers.length === 0) { %>
          <p style="color:var(--text-dim);">No common followers.</p>
        <% } else { %>
          <% commonFollowers.forEach(follower => { %>
            <div class="popup-list-user">
              <img src="<%= follower.profileImageURL || '/default-profile.png' %>" alt="<%= follower.fullname %>'s Profile Image">
              <a href="/profile/<%= follower._id %>"><%= follower.fullname %></a>
            </div>
          <% }) %>
        <% } %>
      </div>
      <div class="blogs-section">
        <h2><i class="fas fa-blog"></i> Blogs by <%= profileUser.fullname %></h2>
        <% if (blogs && blogs.length > 0) { %>
          <% blogs.forEach(blog => { %>
            <div class="blog-card">
              <% if (blog.coverImage && blog.coverImage.length > 0) { %>
                <img class="blog-cover-image" src="<%= blog.coverImage %>" alt="Blog Cover Image" loading="lazy">
              <% } else { %>
                <img class="blog-cover-image" src="/default-blog-cover.jpg" alt="Blog Cover Image" loading="lazy">
              <% } %>
              <div class="blog-card-main">
                <div class="blog-card-title">
                  <a href="/blog/<%= blog._id %>"><%= blog.title %></a>
                </div>
                <div class="blog-card-body">
                  <%= blog.body && blog.body.length > 120 ? blog.body.substring(0, 120) + '...' : blog.body %>
                </div>
              </div>
              <% if (user && blog.createdBy && user._id.toString() === blog.createdBy._id.toString()) { %>
                <div class="blog-menu">
                  <button class="dots-btn" type="button" tabindex="0" aria-label="Blog Options" data-blogid="<%= blog._id %>">
                    <i class="fas fa-ellipsis-v"></i>
                  </button>
                  <div class="dropdown-menu" id="dropdown-<%= blog._id %>">
                    <form action="/blog/<%= blog._id %>?_method=DELETE" method="POST" onsubmit="return confirm('Are you sure you want to delete this blog?');" style="margin:0;">
                      <button type="submit"><i class="fas fa-trash"></i> Delete</button>
                    </form>
                  </div>
                </div>
              <% } %>
            </div>
          <% }) %>
        <% } else { %>
          <p style="color:var(--text-dim);">No blogs yet.</p>
        <% } %>
      </div>
    <% } else { %>
      <div class="alert alert-error">Profile not found.</div>
    <% } %>
  </div>
  <div class="popup-overlay"></div>
  <script>
    // 3-dot blog menu logic
    document.addEventListener('DOMContentLoaded', function() {
      // Dots menu click: toggle dropdown for this blog, close others
      document.querySelectorAll('.dots-btn').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
          e.stopPropagation();
          var blogId = btn.getAttribute('data-blogid');
          var dropdown = document.getElementById('dropdown-' + blogId);
          // Close all other dropdowns
          document.querySelectorAll('.dropdown-menu').forEach(function(menu) {
            if (menu !== dropdown) menu.style.display = 'none';
          });
          // Toggle this dropdown
          dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        });
      });
      // Hide dropdown if clicked outside any .blog-menu
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.blog-menu')) {
          document.querySelectorAll('.dropdown-menu').forEach(function(menu) {
            menu.style.display = 'none';
          });
        }
      });
      // Hide dropdowns on ESC
      window.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          document.querySelectorAll('.dropdown-menu').forEach(function(menu) {
            menu.style.display = 'none';
          });
        }
      });
      // Followers/Following/Common Popups logic
      const followersToggle = document.querySelector('.followers-toggle');
      const followingToggle = document.querySelector('.following-toggle');
      const commonToggle = document.querySelector('.common-toggle');
      const followersPopup = document.querySelector('.followers-popup');
      const followingPopup = document.querySelector('.following-popup');
      const commonPopup = document.querySelector('.common-popup');
      const closeFollowers = document.querySelector('.close-followers');
      const closeFollowing = document.querySelector('.close-following');
      const closeCommon = document.querySelector('.close-common');
      const overlay = document.querySelector('.popup-overlay');
      const showPopup = (popup) => {
        if (popup) {
          popup.style.display = 'block';
          overlay.style.display = 'block';
          popup.focus();
        }
      };
      const hidePopup = (popup) => {
        if (popup) popup.style.display = 'none';
        overlay.style.display = 'none';
      };
      if (followersToggle && followersPopup) {
        followersToggle.addEventListener('click', () => showPopup(followersPopup));
        followersToggle.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            showPopup(followersPopup);
          }
        });
      }
      if (closeFollowers && followersPopup) {
        closeFollowers.addEventListener('click', () => hidePopup(followersPopup));
      }
      if (followingToggle && followingPopup) {
        followingToggle.addEventListener('click', () => showPopup(followingPopup));
        followingToggle.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            showPopup(followingPopup);
          }
        });
      }
      if (closeFollowing && followingPopup) {
        closeFollowing.addEventListener('click', () => hidePopup(followingPopup));
      }
      if (commonToggle && commonPopup) {
        commonToggle.addEventListener('click', () => showPopup(commonPopup));
        commonToggle.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            showPopup(commonPopup);
          }
        });
      }
      if (closeCommon && commonPopup) {
        closeCommon.addEventListener('click', () => hidePopup(commonPopup));
      }
      overlay.addEventListener('click', () => {
        hidePopup(followersPopup);
        hidePopup(followingPopup);
        hidePopup(commonPopup);
      });
      window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          hidePopup(followersPopup);
          hidePopup(followingPopup);
          hidePopup(commonPopup);
        }
      });
    });
  </script>
</body>
</html>
