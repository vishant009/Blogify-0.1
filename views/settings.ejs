<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Account Settings | Blogify</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    body { background: #1a2634; color: #ecf0f1; font-family: Arial,sans-serif; margin:0; }
    .container { max-width: 800px; margin: 2rem auto; padding: 2rem; background: #2c3e50; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,.3);}
    h1 { color: #f1c40f; text-align:center;}
    .btn { background:#f1c40f; color:#1a2634; border:none; border-radius:5px; padding:0.7rem 1.5rem; font-weight:bold; cursor:pointer; margin:0.5rem;}
    .btn:hover { background: #e1b70e;}
    /* Modal Styles */
    .modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100vw; height:100vh; overflow:auto; background:rgba(0,0,0,0.65);}
    .modal-content { background:#233146; margin:5% auto; padding:2rem; border-radius:10px; max-width:400px; position:relative; }
    .close { position:absolute; top:12px; right:20px; color:#fff; font-size:2rem; cursor:pointer; }
    label { color:#f1c40f; font-weight:bold; display:block; margin-bottom:.5rem;}
    input[type="text"], textarea { width:100%; padding:0.7rem; border:none; border-radius:4px; margin-bottom:1.2rem; background:#34495e; color:#ecf0f1;}
    input[type="file"] { color: #f1c40f; margin-bottom:1.2rem;}
    .img-preview { width:60px; height:60px; border-radius:50%; margin-bottom:.75rem; object-fit:cover;}
    .privacy-switch { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.2rem; }
    .switch { position: relative; display: inline-block; width: 54px; height: 28px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px;}
    .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 3px; bottom: 3px; background-color: #fff; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: #f1c40f; }
    input:checked + .slider:before { transform: translateX(26px);}
    .privacy-switch span { font-size: 1rem; color: #f1c40f; font-weight: bold;}
    @media (max-width:768px) { .container {padding:1rem;} .modal-content {padding:1rem;} }
  </style>
</head>
<body>
  <%- include('partials/header', { user }) %>
  <div class="container">
    <h1>Account Settings</h1>
    <% if (success_msg) { %>
      <div class="success_msg"><i class="fas fa-check-circle"></i> <%= success_msg %></div>
    <% } %>
    <% if (error_msg) { %>
      <div class="error_msg"><i class="fas fa-exclamation-circle"></i> <%= error_msg %></div>
    <% } %>
    <div style="text-align:center;">
      <button class="btn" id="openProfileModal"><i class="fas fa-user-edit"></i> Edit Profile</button>
      <button class="btn" id="openAccountModal"><i class="fas fa-user-cog"></i> Account & Privacy</button>
    </div>
  </div>

  <!-- Profile Update Modal -->
  <div id="profileModal" class="modal">
    <div class="modal-content">
      <span class="close" id="closeProfileModal">&times;</span>
      <form action="/settings/update-profile" method="POST" enctype="multipart/form-data">
        <label for="fullname">Full Name</label>
        <input type="text" id="fullname" name="fullname" value="<%= user.fullname %>" required minlength="2" maxlength="50">
        <label for="bio">Bio</label>
        <textarea id="bio" name="bio" rows="3" maxlength="160"><%= user.bio || '' %></textarea>
        <label for="profileImage">Profile Image</label>
        <input type="file" id="profileImage" name="profileImage" accept="image/*" onchange="previewProfileImg(event)">
        <% if (user.profileImageURL) { %>
          <img id="profileImgPreview" src="<%= user.profileImageURL %>" alt="Current Profile" class="img-preview">
        <% } else { %>
          <img id="profileImgPreview" src="" class="img-preview" style="display:none;">
        <% } %>
        <button type="submit" class="btn"><i class="fas fa-save"></i> Update Profile</button>
      </form>
    </div>
  </div>

  <!-- Account/Privacy Modal -->
  <div id="accountModal" class="modal">
    <div class="modal-content">
      <span class="close" id="closeAccountModal">&times;</span>
      <form id="privacy-form" action="/settings/update-privacy" method="POST" style="margin-bottom:1.5rem;">
        <div class="privacy-switch">
          <label for="isPrivate">Private Account</label>
          <label class="switch">
            <input type="checkbox" id="isPrivate" name="isPrivate" value="true" <%= user.isPrivate ? 'checked' : '' %>>
            <span class="slider"></span>
          </label>
          <span id="privacy-label"><%= user.isPrivate ? "Your account is PRIVATE" : "Your account is PUBLIC" %></span>
        </div>
        <button type="submit" class="btn"><i class="fas fa-user-secret"></i> Update Privacy</button>
      </form>
      <form action="/settings/request-password-reset" method="POST">
        <button type="submit" class="btn"><i class="fas fa-key"></i> Reset Password</button>
      </form>
    </div>
  </div>

  <script>
    // Modal functionality
    const profileModal = document.getElementById('profileModal');
    const accountModal = document.getElementById('accountModal');
    document.getElementById('openProfileModal').onclick = () => profileModal.style.display = 'block';
    document.getElementById('openAccountModal').onclick = () => accountModal.style.display = 'block';
    document.getElementById('closeProfileModal').onclick = () => profileModal.style.display = 'none';
    document.getElementById('closeAccountModal').onclick = () => accountModal.style.display = 'none';
    window.onclick = function(event) {
      if (event.target == profileModal) profileModal.style.display = "none";
      if (event.target == accountModal) accountModal.style.display = "none";
    }

    // Profile image preview
    function previewProfileImg(event) {
      const preview = document.getElementById('profileImgPreview');
      preview.style.display = "block";
      preview.src = URL.createObjectURL(event.target.files[0]);
    }

    // Privacy AJAX
    document.addEventListener('DOMContentLoaded', () => {
      const privacySwitch = document.getElementById('isPrivate');
      const privacyLabel = document.getElementById('privacy-label');
      const privacyForm = document.getElementById('privacy-form');
      privacySwitch.addEventListener('change', function() {
        privacyLabel.textContent = this.checked ? "Your account is PRIVATE" : "Your account is PUBLIC";
      });
      privacyForm.addEventListener('submit', function(e) {
        e.preventDefault();
        fetch('/settings/update-privacy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-Requested-With': 'XMLHttpRequest' },
          body: 'isPrivate=' + (privacySwitch.checked ? 'true' : '')
        })
        .then(res => res.json())
        .then(data => {
          privacyLabel.textContent = privacySwitch.checked ? "Your account is PRIVATE" : "Your account is PUBLIC";
          alert(data.success ? data.message : ("Error: " + (data.error || "Failed to update privacy")));
        })
        .catch(() => alert("Failed to update privacy. Please try again."));
      });
    });
  </script>
</body>
</html>
